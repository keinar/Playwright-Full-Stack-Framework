# Use a lightweight Node image as this is only an orchestrator
FROM node:20-slim

# The manager needs to communicate with Docker, but doesn't need Playwright itself
WORKDIR /app

# Copy monorepo configuration
COPY package.json package-lock.json tsconfig.json ./
COPY packages/shared-types ./packages/shared-types
COPY apps/worker-service ./apps/worker-service

# Install dependencies including 'dockerode'
RUN npm install --legacy-peer-deps

# Build shared types first
WORKDIR /app/packages/shared-types
RUN npm run build

# Build the worker manager
WORKDIR /app/apps/worker-service
RUN npm run build

ENV NODE_ENV=production

# The manager script runs as the entry point
CMD ["node", "dist/worker.js"]